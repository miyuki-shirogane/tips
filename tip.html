<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>☕️ 打赏</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      margin: 0;
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f2f2f2, #e6e6e6);
    }

    .card {
      margin-top: 6vh;
      background: #fff;
      padding: 80px 70px;
      border-radius: 36px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.18);
      text-align: center;
      width: 620px;
      max-width: 92%;
    }

    .emoji {
      font-size: 80px;
      margin-bottom: 28px;
      display: block;
    }

    h3 {
      font-size: 42px;
      margin: 0 0 36px;
      color: #222;
      font-weight: 600;
    }

    /* 按钮通用样式 */
    .btn {
      padding: 24px 64px;
      font-size: 28px;
      font-weight: 600;
      color: #000;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.18s ease;
      margin: 12px 0;
      width: 100%;
      box-sizing: border-box;
    }

    .btn:hover {
      background: #fafafa;
      border-color: #999;
      transform: translateY(-1px);
    }

    .btn:active {
      background: #eee;
      transform: translateY(0);
    }

    /* 禁用状态 */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      background: #f5f5f5 !important;
      border-color: #ddd !important;
    }

    /* 连接按钮特殊样式 */
    #connectBtn {
      border-color: #4299e1;
      color: #4299e1;
    }

    #connectBtn:hover:not(:disabled) {
      background: #e8f4ff;
      border-color: #3182ce;
    }

    /* 打赏按钮特殊样式 */
    #tipBtn {
      display: none;
    }

    /* 状态提示 */
    .status {
      font-size: 20px;
      margin: 24px 0;
      min-height: 24px;
    }

    .status.success {
      color: #38a169;
    }

    .status.error {
      color: #e53e3e;
    }

    .status.warning {
      color: #dd6b20;
    }

    /* 用户地址展示 */
    .address {
      font-size: 16px;
      color: #666;
      margin: 16px 0;
      word-break: break-all;
      padding: 12px;
      background: #f8f8f8;
      border-radius: 12px;
    }

    .footer {
      margin-top: 44px;
      font-size: 17px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="card">
    <span class="emoji">☕️</span>
    <h3>请作者喝杯咖啡</h3>

    <!-- 状态提示 -->
    <div id="status" class="status">检测钱包环境中...</div>

    <!-- 用户地址 -->
    <div id="addressContainer" class="address" style="display: none;"></div>

    <!-- 连接钱包按钮 -->
    <button id="connectBtn" class="btn" disabled>连接 SupeRISE 钱包</button>

    <!-- 打赏按钮 -->
    <button id="tipBtn" class="btn">打赏 2000 CKB</button>

    <div class="footer">
      感谢支持 ❤️
    </div>
  </div>

  <script>
    // 配置项
    const CONFIG = {
      // 连接超时时间（毫秒），这里设置10秒
      CONNECT_TIMEOUT: 10000,
      // 打赏地址和金额
      TIP_ADDRESS: "ckt1qrfrwcdnvssswdwpn3s9v8fp87emat306ctjwsm3nmlkjg8qyza2cqgqqx4q8n46evp22qlt934kn93auhp8kgrmkggxvm0n",
      TIP_AMOUNT: 2000 * 10 ** 8 // 2000 CKB
    };

    // 全局状态
    let walletConnected = false;
    let walletAddress = "";
    let connectTimer = null;

    // DOM 元素
    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const tipBtn = document.getElementById("tipBtn");
    const addressContainer = document.getElementById("addressContainer");

    // 初始化：检测钱包环境
    function init() {
      // 检测是否是 SupeRISE 钱包环境
      if (!window.superise) {
        updateStatus("非 SupeRISE 钱包环境，请在钱包内打开", "error");
        connectBtn.disabled = true;
        return;
      }

      // 检测到钱包环境，准备连接
      updateStatus("已检测到 SupeRISE 钱包，请点击按钮连接", "warning");
      connectBtn.disabled = false;

      // 绑定连接按钮事件
      connectBtn.addEventListener("click", connectWalletWithTimeout);
      // 绑定打赏按钮事件
      tipBtn.addEventListener("click", handleTip);
    }

    // 更新状态提示
    function updateStatus(text, type = "normal") {
      statusEl.textContent = text;
      statusEl.className = `status ${type}`;
    }

    // 连接钱包（带超时）
    async function connectWalletWithTimeout() {
      // 禁用连接按钮，防止重复点击
      connectBtn.disabled = true;
      updateStatus("正在请求连接钱包，请在钱包内确认...", "warning");

      // 设置超时定时器
      connectTimer = setTimeout(() => {
        updateStatus("连接超时，请重新尝试", "error");
        connectBtn.disabled = false;
        walletConnected = false;
      }, CONFIG.CONNECT_TIMEOUT);

      try {
        // 显式调用连接钱包 API
        const walletInfo = await window.superise.connectCkb();

        // 清除超时定时器
        clearTimeout(connectTimer);

        // 连接成功
        walletConnected = true;
        walletAddress = walletInfo.address;

        // 更新界面
        updateStatus("钱包连接成功！", "success");
        addressContainer.textContent = `当前连接地址：${walletAddress}`;
        addressContainer.style.display = "block";
        connectBtn.style.display = "none";
        tipBtn.style.display = "block";
      } catch (error) {
        // 连接失败
        clearTimeout(connectTimer);
        updateStatus(`连接失败：${error.message}`, "error");
        connectBtn.disabled = false;
        walletConnected = false;
      }
    }

    // 处理打赏逻辑
    async function handleTip() {
      if (!walletConnected) {
        updateStatus("请先连接钱包", "error");
        return;
      }

      try {
        updateStatus("正在发起转账，请在钱包内确认...", "warning");
        tipBtn.disabled = true;

        // 调用转账 API
        const res = await window.superise.transferCKB(
          CONFIG.TIP_ADDRESS,
          CONFIG.TIP_AMOUNT,
          Date.now() + 120000 // 2分钟过期时间
        );

        // 转账成功
        updateStatus("打赏成功！感谢你的支持～", "success");
        alert(`感谢支持！\n交易哈希：${res.txHash}`);
        window.close();
      } catch (error) {
        // 转账失败
        updateStatus(`打赏失败：${error.message}`, "error");
        alert(`已取消或失败：${error.message}`);
        tipBtn.disabled = false;
      }
    }

    // 页面加载完成后初始化
    window.addEventListener("DOMContentLoaded", init);
    // 监听钱包 Bridge 就绪事件
    window.addEventListener("superiseReady", () => {
      updateStatus("钱包桥接已就绪，请点击按钮连接", "warning");
    });
  </script>
</body>
</html>