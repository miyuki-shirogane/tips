<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>☕️ 打赏</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      margin: 0;
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f2f2f2, #e6e6e6);
    }

    .card {
      margin-top: 6vh;
      background: #fff;
      padding: 80px 70px;
      border-radius: 36px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.18);
      text-align: center;
      width: 620px;
      max-width: 92%;
    }

    .emoji {
      font-size: 80px;
      margin-bottom: 28px;
      display: block;
    }

    h3 {
      font-size: 42px;
      margin: 0 0 36px;
      color: #222;
      font-weight: 600;
    }

    /* 按钮通用样式 */
    .btn {
      padding: 24px 64px;
      font-size: 28px;
      font-weight: 600;
      color: #000;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.18s ease;
      margin: 12px 0;
      width: 100%;
      box-sizing: border-box;
    }

    .btn:hover {
      background: #fafafa;
      border-color: #999;
      transform: translateY(-1px);
    }

    .btn:active {
      background: #eee;
      transform: translateY(0);
    }

    /* 禁用状态 */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      background: #f5f5f5 !important;
      border-color: #ddd !important;
    }

    /* 连接按钮特殊样式 */
    #connectBtn {
      border-color: #4299e1;
      color: #4299e1;
    }

    #connectBtn:hover:not(:disabled) {
      background: #e8f4ff;
      border-color: #3182ce;
    }

    /* 打赏按钮特殊样式 */
    #tipBtn {
      display: none;
    }

    /* 状态提示 */
    .status {
      font-size: 20px;
      margin: 24px 0;
      min-height: 24px;
    }

    .status.success {
      color: #38a169;
    }

    .status.error {
      color: #e53e3e;
    }

    .status.warning {
      color: #dd6b20;
    }

    /* 用户地址展示 */
    .address {
      font-size: 16px;
      color: #666;
      margin: 16px 0;
      word-break: break-all;
      padding: 12px;
      background: #f8f8f8;
      border-radius: 12px;
    }

    /* 调试日志面板 - 新增样式 */
    .debug-panel {
      margin: 20px 0;
      padding: 16px;
      background: #f0f8ff;
      border-radius: 12px;
      text-align: left;
      font-size: 14px;
      color: #333;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e8f4ff;
    }

    .debug-panel h4 {
      margin: 0 0 8px 0;
      color: #4299e1;
      font-size: 16px;
    }

    .debug-log {
      margin: 4px 0;
      line-height: 1.4;
    }

    .footer {
      margin-top: 44px;
      font-size: 17px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="card">
    <span class="emoji">☕️</span>
    <h3>请作者喝杯咖啡</h3>

    <!-- 状态提示 -->
    <div id="status" class="status">检测钱包环境中...</div>

    <!-- 新增：调试日志面板 -->
    <div class="debug-panel">
      <h4>调试日志（F12控制台可查看更详细信息）：</h4>
      <div id="debugLogs"></div>
    </div>

    <!-- 用户地址 -->
    <div id="addressContainer" class="address" style="display: none;"></div>

    <!-- 连接钱包按钮 -->
    <button id="connectBtn" class="btn" disabled>连接 SupeRISE 钱包</button>

    <!-- 打赏按钮 -->
    <button id="tipBtn" class="btn">打赏 2000 CKB</button>

    <div class="footer">
      感谢支持 ❤️
    </div>
  </div>

  <script>
    // 配置项
    const CONFIG = {
      // 连接超时时间（毫秒），这里设置10秒
      CONNECT_TIMEOUT: 10000,
      // 打赏地址和金额
      TIP_ADDRESS: "ckt1qrfrwcdnvssswdwpn3s9v8fp87emat306ctjwsm3nmlkjg8qyza2cqgqqx4q8n46evp22qlt934kn93auhp8kgrmkggxvm0n",
      TIP_AMOUNT: 2000 * 10 ** 8 // 2000 CKB
    };

    // 全局状态
    let walletConnected = false;
    let walletAddress = "";
    let connectTimer = null;
    let debugLogIndex = 0; // 新增：调试日志序号

    // DOM 元素
    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const tipBtn = document.getElementById("tipBtn");
    const addressContainer = document.getElementById("addressContainer");
    const debugLogsEl = document.getElementById("debugLogs"); // 新增：调试日志DOM

    // 新增：调试日志函数（核心新增功能）
    function addDebugLog(message, type = "log") {
      // 生成带时间戳的日志
      const timestamp = new Date().toLocaleTimeString();
      const logContent = `[${timestamp}] ${message}`;
      debugLogIndex++;
      const logHtml = `<div class="debug-log">[${debugLogIndex}] ${logContent}</div>`;

      // 1. 显示在页面调试面板
      debugLogsEl.innerHTML += logHtml;
      debugLogsEl.scrollTop = debugLogsEl.scrollHeight; // 自动滚动到最新日志

      // 2. 打印到浏览器控制台（区分类型）
      switch (type) {
        case "error":
          console.error(logContent);
          break;
        case "warn":
          console.warn(logContent);
          break;
        case "info":
          console.info(logContent);
          break;
        default:
          console.log(logContent);
      }
    }

    // 初始化：检测钱包环境
    function init() {
      addDebugLog("页面初始化开始，检测钱包环境", "info"); // 新增日志

      // 检测是否是 SupeRISE 钱包环境
      if (!window.superise) {
        addDebugLog("未检测到window.superise，非SupeRISE钱包环境", "error"); // 新增日志
        updateStatus("非 SupeRISE 钱包环境，请在钱包内打开", "error");
        connectBtn.disabled = true;
        return;
      }

      addDebugLog("已检测到SupeRISE钱包环境，超时时间设置为10秒", "info"); // 新增日志
      // 检测到钱包环境，准备连接
      updateStatus("已检测到 SupeRISE 钱包，请点击按钮连接", "warning");
      connectBtn.disabled = false;

      // 绑定连接按钮事件
      connectBtn.addEventListener("click", connectWalletWithTimeout);
      // 绑定打赏按钮事件
      tipBtn.addEventListener("click", handleTip);
    }

    // 更新状态提示（新增日志）
    function updateStatus(text, type = "normal") {
      statusEl.textContent = text;
      statusEl.className = `status ${type}`;
      addDebugLog(`状态更新：${text} (类型：${type})`, "info"); // 新增日志
    }

    // 连接钱包（带超时，新增详细日志）
    async function connectWalletWithTimeout() {
      addDebugLog("用户点击连接钱包按钮，开始连接流程", "info"); // 新增日志

      // 禁用连接按钮，防止重复点击
      connectBtn.disabled = true;
      updateStatus("正在请求连接钱包，请在钱包内确认...", "warning");

      // 记录连接开始时间（新增）
      const connectStartTime = Date.now();
      addDebugLog(`连接请求发起，开始计时（超时时间${CONFIG.CONNECT_TIMEOUT}ms）`, "info"); // 新增日志

      // 设置超时定时器
      connectTimer = setTimeout(() => {
        const timeoutDuration = Date.now() - connectStartTime;
        addDebugLog(`连接超时！耗时${timeoutDuration}ms，超过设定的${CONFIG.CONNECT_TIMEOUT}ms`, "error"); // 新增日志
        updateStatus("连接超时，请重新尝试", "error");
        connectBtn.disabled = false;
        walletConnected = false;
      }, CONFIG.CONNECT_TIMEOUT);

      try {
        addDebugLog("开始调用window.superise.connectCkb() API", "info"); // 新增日志
        // 显式调用连接钱包 API
        const walletInfo = await window.superise.connectCkb();

        // 清除超时定时器
        clearTimeout(connectTimer);
        addDebugLog("connectCkb调用成功，清除超时定时器", "success"); // 新增日志

        // 连接成功
        walletConnected = true;
        walletAddress = walletInfo.address;
        addDebugLog(`钱包连接成功，地址：${walletAddress}`, "success"); // 新增日志

        // 更新界面
        updateStatus("钱包连接成功！", "success");
        addressContainer.textContent = `当前连接地址：${walletAddress}`;
        addressContainer.style.display = "block";
        connectBtn.style.display = "none";
        tipBtn.style.display = "block";
      } catch (error) {
        // 连接失败
        clearTimeout(connectTimer);
        addDebugLog(`connectCkb调用失败：${error.message} | 错误栈：${error.stack}`, "error"); // 新增日志
        updateStatus(`连接失败：${error.message}`, "error");
        connectBtn.disabled = false;
        walletConnected = false;
      }
    }

    // 处理打赏逻辑（仅新增基础日志，不修改原有逻辑）
    async function handleTip() {
      addDebugLog("用户点击打赏按钮", "info"); // 新增日志

      if (!walletConnected) {
        addDebugLog("打赏拦截：钱包未连接", "warn"); // 新增日志
        updateStatus("请先连接钱包", "error");
        return;
      }

      try {
        updateStatus("正在发起转账，请在钱包内确认...", "warning");
        tipBtn.disabled = true;
        addDebugLog("开始调用transferCKB API，过期时间2分钟", "info"); // 新增日志

        // 调用转账 API
        const res = await window.superise.transferCKB(
          CONFIG.TIP_ADDRESS,
          CONFIG.TIP_AMOUNT,
          Date.now() + 120000 // 2分钟过期时间
        );

        // 转账成功
        addDebugLog(`打赏成功，交易哈希：${res.txHash}`, "success"); // 新增日志
        updateStatus("打赏成功！感谢你的支持～", "success");
        alert(`感谢支持！\n交易哈希：${res.txHash}`);
        window.close();
      } catch (error) {
        // 转账失败
        addDebugLog(`打赏失败：${error.message} | 错误栈：${error.stack}`, "error"); // 新增日志
        updateStatus(`打赏失败：${error.message}`, "error");
        alert(`已取消或失败：${error.message}`);
        tipBtn.disabled = false;
      }
    }

    // 新增：监听superiseReady事件并打印日志
    window.addEventListener("superiseReady", () => {
      addDebugLog("监听到superiseReady事件，钱包桥接已就绪", "success");
      updateStatus("钱包桥接已就绪，请点击按钮连接", "warning");
    });

    // 新增：全局错误捕获
    window.addEventListener("error", (event) => {
      addDebugLog(`全局错误：${event.message}，文件：${event.filename}，行号：${event.lineno}`, "error");
    });

    window.addEventListener("unhandledrejection", (event) => {
      addDebugLog(`未捕获Promise错误：${event.reason?.message || event.reason}`, "error");
    });

    // 页面加载完成后初始化
    window.addEventListener("DOMContentLoaded", () => {
      addDebugLog("页面DOM加载完成，准备执行初始化", "info"); // 新增日志
      init();
    });
  </script>
</body>
</html>