<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>â˜•ï¸ æ‰“èµ & è¿›å…¥åº”ç”¨</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      margin: 0;
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f2f2f2, #e6e6e6);
    }

    .card {
      margin-top: 6vh;
      background: #fff;
      padding: 80px 70px;
      border-radius: 36px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.18);
      text-align: center;
      width: 620px;
      max-width: 92%;
    }

    .emoji {
      font-size: 80px;
      margin-bottom: 28px;
      display: block;
    }

    h3 {
      font-size: 42px;
      margin: 0 0 36px;
      color: #222;
      font-weight: 600;
    }

    /* æŒ‰é’®é€šç”¨æ ·å¼ */
    .btn {
      padding: 24px 64px;
      font-size: 28px;
      font-weight: 600;
      color: #000;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.18s ease;
      margin: 12px 0;
      width: 100%;
      box-sizing: border-box;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background: #fafafa;
      border-color: #999;
      transform: translateY(-1px);
    }

    .btn:active {
      background: #eee;
      transform: translateY(0);
    }

    /* ç¦ç”¨çŠ¶æ€ */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      background: #f5f5f5 !important;
      border-color: #ddd !important;
    }

    /* è¿æ¥é’±åŒ…æŒ‰é’® */
    #connectBtn {
      border-color: #4299e1;
      color: #4299e1;
    }

    #connectBtn:hover:not(:disabled) {
      background: #e8f4ff;
      border-color: #3182ce;
    }

    /* æ‰“èµæŒ‰é’® */
    #tipBtn {
      border-color: #48bb78;
      color: #48bb78;
      display: none;
    }

    #tipBtn:hover:not(:disabled) {
      background: #f0fdf4;
      border-color: #38a169;
    }

    /* è¿›å…¥åº”ç”¨æŒ‰é’® */
    #enterAppBtn {
      border-color: #9f7aea;
      color: #9f7aea;
    }

    #enterAppBtn:hover:not(:disabled) {
      background: #fdf2f8;
      border-color: #805ad5;
    }

    /* çŠ¶æ€æç¤º */
    .status {
      font-size: 20px;
      margin: 24px 0;
      min-height: 24px;
    }

    .status.success {
      color: #38a169;
    }

    .status.error {
      color: #e53e3e;
    }

    .status.warning {
      color: #dd6b20;
    }

    .footer {
      margin-top: 44px;
      font-size: 17px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="card">
    <span class="emoji">â˜•ï¸</span>
    <h3>æ¬¢è¿ä½¿ç”¨ï¼</h3>

    <!-- çŠ¶æ€æç¤º -->
    <div id="status" class="status">æ£€æµ‹é’±åŒ…ç¯å¢ƒä¸­...</div>

    <!-- è¿æ¥é’±åŒ…æŒ‰é’® -->
    <button id="connectBtn" class="btn" disabled>è¿æ¥ SupeRISE é’±åŒ…</button>

    <!-- æ‰“èµæŒ‰é’® -->
    <button id="tipBtn" class="btn">æ‰“èµ 2000 CKB æ”¯æŒä½œè€…</button>

    <!-- è¿›å…¥åº”ç”¨æŒ‰é’® -->
    <a href="http://192.168.12.100:8501" target="_self" id="enterAppBtn" class="btn">
      ğŸš€ è¿›å…¥æ¸¸æˆåº”ç”¨
    </a>

    <div class="footer">
      æ„Ÿè°¢æ”¯æŒ â¤ï¸
    </div>
  </div>

  <script>
    // é…ç½®é¡¹ï¼ˆä¿ç•™ä½ ä¹‹å‰çš„æ ¸å¿ƒé…ç½®ï¼‰
    const CONFIG = {
      CONNECT_TIMEOUT: 20000, // 20ç§’è¶…æ—¶
      TIP_ADDRESS: "ckt1qrfrwcdnvssswdwpn3s9v8fp87emat306ctjwsm3nmlkjg8qyza2cqgqqx4q8n46evp22qlt934kn93auhp8kgrmkggxvm0n",
      TIP_AMOUNT: 2000 * 10 ** 8, // 2000 CKB
      STREAMLIT_URL: "http://192.168.12.100:8501"
    };

    // å…¨å±€çŠ¶æ€ï¼ˆä¿ç•™è¿æ¥çŠ¶æ€ï¼‰
    let walletConnected = false;
    let connectTimer = null;

    // DOM å…ƒç´ 
    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const tipBtn = document.getElementById("tipBtn");
    const enterAppBtn = document.getElementById("enterAppBtn");

    // æ›´æ–°çŠ¶æ€æç¤ºï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
    function updateStatus(text, type = "normal") {
      statusEl.textContent = text;
      statusEl.className = `status ${type}`;
    }

    // åˆå§‹åŒ–ï¼šæ£€æµ‹é’±åŒ…ç¯å¢ƒï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
    function init() {
      // æ£€æµ‹é’±åŒ…ç¯å¢ƒ
      if (!window.superise) {
        updateStatus("é SupeRISE é’±åŒ…ç¯å¢ƒï¼Œè¯·åœ¨é’±åŒ…å†…æ‰“å¼€", "error");
        connectBtn.disabled = true;
        return;
      }

      updateStatus("å·²æ£€æµ‹åˆ° SupeRISE é’±åŒ…ï¼Œè¯·ç‚¹å‡»æŒ‰é’®è¿æ¥", "warning");
      connectBtn.disabled = false;
      // ç»‘å®šè¿æ¥æŒ‰é’®äº‹ä»¶
      connectBtn.addEventListener("click", connectWalletWithTimeout);
      // ç»‘å®šæ‰“èµæŒ‰é’®äº‹ä»¶
      tipBtn.addEventListener("click", handleTip);
    }

    // è¿æ¥é’±åŒ…ï¼ˆä¿ç•™ä½ éªŒè¯è¿‡çš„è¶…æ—¶é€»è¾‘ï¼‰
    async function connectWalletWithTimeout() {
      connectBtn.disabled = true;
      updateStatus("æ­£åœ¨è¯·æ±‚è¿æ¥é’±åŒ…ï¼Œè¯·åœ¨é’±åŒ…å†…ç¡®è®¤...", "warning");

      // è®¾ç½®è¶…æ—¶å®šæ—¶å™¨
      connectTimer = setTimeout(() => {
        updateStatus("è¿æ¥è¶…æ—¶ï¼Œè¯·é‡æ–°å°è¯•", "error");
        connectBtn.disabled = false;
        walletConnected = false;
      }, CONFIG.CONNECT_TIMEOUT);

      try {
        // æ˜¾å¼è¿æ¥é’±åŒ…ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        const walletInfo = await window.superise.connectCkb();
        clearTimeout(connectTimer);

        // è¿æ¥æˆåŠŸ
        walletConnected = true;
        updateStatus("é’±åŒ…è¿æ¥æˆåŠŸï¼å¯ç‚¹å‡»æ‰“èµ", "success");
        connectBtn.style.display = "none";
        tipBtn.style.display = "block";
      } catch (error) {
        clearTimeout(connectTimer);
        updateStatus(`è¿æ¥å¤±è´¥ï¼š${error.message}`, "error");
        connectBtn.disabled = false;
        walletConnected = false;
      }
    }

    // æ‰“èµé€»è¾‘ï¼ˆä¿ç•™åŸæœ‰æ”¯ä»˜é€»è¾‘ï¼‰
    async function handleTip() {
      if (!walletConnected) {
        updateStatus("è¯·å…ˆè¿æ¥é’±åŒ…", "error");
        return;
      }

      try {
        updateStatus("æ­£åœ¨å‘èµ·è½¬è´¦ï¼Œè¯·åœ¨é’±åŒ…å†…ç¡®è®¤...", "warning");
        tipBtn.disabled = true;

        // è°ƒç”¨è½¬è´¦APIï¼ˆæ ¸å¿ƒæ”¯ä»˜é€»è¾‘ï¼‰
        const res = await window.superise.transferCKB(
          CONFIG.TIP_ADDRESS,
          CONFIG.TIP_AMOUNT,
          Date.now() + 120000 // 2åˆ†é’Ÿè¿‡æœŸ
        );

        // æ”¯ä»˜æˆåŠŸ
        updateStatus("æ‰“èµæˆåŠŸï¼æ„Ÿè°¢æ”¯æŒï½", "success");
        alert(`æ„Ÿè°¢æ”¯æŒï¼\näº¤æ˜“å“ˆå¸Œï¼š${res.txHash}`);
        // è‡ªåŠ¨è·³è½¬Streamlit
        window.location.href = CONFIG.STREAMLIT_URL;
      } catch (error) {
        updateStatus(`æ‰“èµå¤±è´¥ï¼š${error.message}`, "error");
        alert(`å·²å–æ¶ˆæˆ–å¤±è´¥ï¼š${error.message}`);
        tipBtn.disabled = false;
      }
    }

    // é¡µé¢åŠ è½½+Bridgeå°±ç»ªåˆå§‹åŒ–
    window.addEventListener("DOMContentLoaded", init);
    window.addEventListener("superiseReady", init);
  </script>
</body>
</html>